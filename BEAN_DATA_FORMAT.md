# Coffee Bean Data Format Documentation

This document describes the data format and structure of saved coffee bean JSON files and diff files used by the Kissaten scraper system.

## Table of Contents

- [Directory Structure](#directory-structure)
- [JSON Bean Files](#json-bean-files)
  - [File Naming Convention](#file-naming-convention)
  - [Data Structure](#data-structure)
  - [Field Descriptions](#field-descriptions)
- [DiffJSON Files](#diffjson-files)
  - [File Naming Convention](#diffjson-file-naming-convention)
  - [Data Structure](#diffjson-data-structure)
  - [Use Cases](#use-cases)
- [Data Validation](#data-validation)
- [Examples](#examples)

## Directory Structure

Coffee bean data is organized in a hierarchical directory structure:

```
data/
└── roasters/
    └── <roaster_name>/
        └── <session_date>/
            ├── <bean_uid>.json          # Full bean data
            ├── <bean_uid>.originaljson   # Original language version (optional)
            ├── <bean_uid>.png            # Product image (optional)
            ├── <product_slug>.diffjson   # Stock/field updates
            └── <product_slug>_out_of_stock.diffjson  # Out-of-stock updates
```

### Directory Components

- **`roasters/`**: Root directory for all roaster data
- **`<roaster_name>/`**: Normalized roaster name (spaces replaced with underscores, lowercase)
  - Example: `"MOK Coffee"` → `mok_coffee`
- **`<session_date>/`**: Scraping session date in `YYYYMMDD` format
  - Example: `20251119` for November 19, 2025
- **Files**: Individual bean data files and updates

## JSON Bean Files

### File Naming Convention

JSON bean files use the following naming pattern:

```
<bean_uid>.json
```

Where `<bean_uid>` is generated by the `create_bean_uid()` method:

1. **Base name**: Cleaned bean name (special characters replaced with underscores)
2. **Process suffix**: Processing method appended if available (e.g., `_washed`, `_natural`)
3. **Timestamp**: Time of scraping in `HHMMSS` format for uniqueness
4. **Length limit**: Base name truncated to 100 characters if too long

**Example filenames:**
- `espresso_a_ethiopia_suke_quto_washed_162013.json`
- `kenya_kianamui_ab_washed_161752.json`
- `colombia_el_ocaso_natural_161849.json`

### Data Structure

The JSON file contains a complete `CoffeeBean` object serialized using Pydantic's `model_dump_json()`. The structure follows this schema:

```json
{
  "name": "string (required, 1-200 chars)",
  "roaster": "string (required, 1-100 chars)",
  "url": "string (required, valid HTTP/HTTPS URL)",
  "image_url": "string | null (valid HTTP/HTTPS URL)",
  "description": "string | null (max 5000 chars)",
  "origins": [
    {
      "country": "string | null (2-letter country code, e.g., 'ET', 'CO')",
      "region": "string | null (1-100 chars)",
      "producer": "string | null (1-100 chars)",
      "farm": "string | null (1-100 chars)",
      "elevation_min": "integer (0-3000, default: 0)",
      "elevation_max": "integer (0-3000, default: 0)",
      "latitude": "float | null (-90 to 90)",
      "longitude": "float | null (-180 to 180)",
      "process": "string | null (max 100 chars, e.g., 'Washed', 'Natural', 'Honey')",
      "variety": "string | null (max 100 chars, e.g., 'Bourbon', 'Catuai')",
      "harvest_date": "string | null (ISO 8601 datetime)",
      "fob_price": "float | null (price per kg in USD, 0.5-300)",
      "farm_gate_price": "float | null (price per kg in USD, 0.5-300)",
      "price_paid_to_producer": "float | null (price per kg in USD, 0.5-300)",
      "price_currency": "string | null (3-letter currency code)",
      "importer_name": "string | null (1-200 chars)"
    }
  ],
  "is_single_origin": "boolean (default: true)",
  "price_paid_for_green_coffee": "float | null",
  "currency_of_price_paid_for_green_coffee": "string | null",
  "roast_level": "string | null (enum: 'Extra-Light', 'Light', 'Medium-Light', 'Medium', 'Medium-Dark', 'Dark')",
  "roast_profile": "string | null (enum: 'Espresso', 'Filter', 'Omni')",
  "price_options": [
    {
      "weight": "integer | null (10-10000 grams)",
      "price": "float (required, > 0)"
    }
  ],
  "price": "float | null (> 0, local currency)",
  "weight": "integer | null (> 0, grams)",
  "currency": "string | null (3-letter code, default: 'GBP')",
  "is_decaf": "boolean (default: false)",
  "cupping_score": "float | null (70-100)",
  "tasting_notes": ["string"] (array of normalized flavor notes),
  "in_stock": "boolean | null",
  "scraped_at": "string (ISO 8601 datetime with timezone, default: current UTC time)",
  "scraper_version": "string (default: '1.0')",
  "raw_data": "string | null (raw scraped data for debugging)"
}
```

### Field Descriptions

#### Basic Information

- **`name`**: Coffee bean product name as displayed on the roaster's website
- **`roaster`**: Name of the coffee roaster
- **`url`**: Full product URL on the roaster's website (used as unique identifier)
- **`image_url`**: URL of the product image (optional)
- **`description`**: Full product description from the roaster's website

#### Origin and Processing

- **`origins`**: Array of origin objects (one for single origin, multiple for blends)
  - **`country`**: Two-letter ISO country code (e.g., `"ET"` for Ethiopia, `"CO"` for Colombia)
  - **`region`**: Region within the country (e.g., `"Guji"`, `"Antioquia"`)
  - **`producer`**: Producer name (usually a person's name)
  - **`farm`**: Farm name
  - **`elevation_min`/`elevation_max`**: Elevation range in meters above sea level (0 if unknown)
  - **`latitude`/`longitude`**: Geographic coordinates (only if explicitly provided, not guessed)
  - **`process`**: Processing method (Washed, Natural, Honey, Anaerobic, etc.)
  - **`variety`**: Coffee variety/varietal (Bourbon, Catuai, Gesha, etc.)
  - **`harvest_date`**: Harvest date (ISO 8601 format, earliest date if range provided)
  - **Cost Transparency Fields**: Optional pricing information for green coffee
    - **`fob_price`**: Free On Board price per kg in USD
    - **`farm_gate_price`**: Farm gate price per kg in USD
    - **`price_paid_to_producer`**: Price paid to producer per kg in USD
    - **`price_currency`**: Currency code for prices
    - **`importer_name`**: Name of the importer/trading company

- **`is_single_origin`**: `true` for single origin, `false` for blends
- **`price_paid_for_green_coffee`**: Price paid for 1kg of green coffee (legacy field)
- **`currency_of_price_paid_for_green_coffee`**: Currency for green coffee price (legacy field)

#### Product Details

- **`roast_level`**: Roast level enum value (Extra-Light, Light, Medium-Light, Medium, Medium-Dark, Dark)
- **`roast_profile`**: Intended brewing method (Espresso, Filter, or Omni for both)
- **`price_options`**: Array of available price/weight combinations
  - Each option contains `weight` (grams) and `price` (local currency)
  - Used when multiple package sizes are available
- **`price`**: Default price in local currency (typically for the option nearest to 200g)
- **`weight`**: Default weight in grams (typically for the option nearest to 200g)
- **`currency`**: Three-letter currency code (e.g., `"GBP"`, `"EUR"`, `"USD"`)
- **`is_decaf`**: Whether the coffee is decaffeinated
- **`cupping_score`**: Cupping score (70-100), only included if explicitly stated

#### Flavor Profile

- **`tasting_notes`**: Array of flavor notes in order they appear in the description
  - Notes are normalized (title case, deduplicated, empty strings removed)
  - Example: `["Floral", "Sweet", "Citrus", "Jasmine"]`

#### Availability and Metadata

- **`in_stock`**: Stock availability status (`true` if in stock, `false` if out of stock, `null` if unknown)
- **`scraped_at`**: ISO 8601 datetime string with timezone (UTC) indicating when the data was scraped
- **`scraper_version`**: Version of the scraper used (e.g., `"1.0"`, `"2.0"`)
- **`raw_data`**: Optional raw scraped data for debugging purposes

## DiffJSON Files

DiffJSON files are lightweight update files used to track changes to existing coffee beans without re-scraping the entire product page. They are particularly useful for:

1. **Stock status updates**: Tracking when products go in or out of stock
2. **Price updates**: Updating prices without full re-scraping
3. **Field updates**: Updating specific fields that may have changed

### DiffJSON File Naming Convention

DiffJSON files use a different naming convention based on the product URL:

```
<product_slug>.diffjson
<product_slug>_out_of_stock.diffjson
```

Where `<product_slug>` is extracted from the product URL:

1. Extract the product slug from the URL path (typically after `/products/` or the last path segment)
2. Clean the slug: replace non-alphanumeric characters (except hyphens and underscores) with underscores
3. Collapse multiple consecutive underscores into one
4. Remove leading/trailing underscores

**Example filenames:**
- `costarica-laslajas.diffjson`
- `kenya-kianamui-ab-washed_out_of_stock.diffjson`
- `espresso-a-amkeni_out_of_stock.diffjson`

### DiffJSON Data Structure

DiffJSON files contain a partial `CoffeeBeanDiffUpdate` object with only the fields that need to be updated. The structure is:

```json
{
  "url": "string (required, valid HTTP/HTTPS URL - identifies which bean to update)",
  "name": "string | null (optional, 1-200 chars)",
  "roast_level": "string | null (optional, enum value)",
  "roast_profile": "string | null (optional, 'Espresso' | 'Filter' | 'Omni')",
  "price_options": [
    {
      "weight": "integer | null (50-10000 grams)",
      "price": "float (required, > 0)"
    }
  ],
  "price": "float | null (optional, > 0)",
  "weight": "integer | null (optional, 50-10000 grams)",
  "currency": "string | null (optional, 3-letter code)",
  "is_decaf": "boolean | null (optional)",
  "cupping_score": "float | null (optional, 70-100)",
  "description": "string | null (optional, max 5000 chars)",
  "in_stock": "boolean | null (optional)",
  "tasting_notes": ["string"] | null (optional, array of flavor notes),
  "scraped_at": "string | null (optional, ISO 8601 datetime)",
  "scraper_version": "string | null (optional)"
}
```

**Key differences from full JSON files:**

1. **Only `url` is required** - all other fields are optional
2. **No `origins` field** - origin data is not updated via diffjson
3. **No `roaster` field** - roaster is immutable
4. **No `image_url` field** - images are not updated via diffjson
5. **Fields are excluded if `null`** - the schema uses `exclude_none=True` for serialization

### Use Cases

#### 1. Stock Status Updates

The most common use case is updating stock status for existing products:

**In-stock update:**
```json
{
  "url": "https://mokcoffee.be/collections/coffee/products/costarica-laslajas",
  "in_stock": true,
  "scraped_at": "2025-11-19T16:20:02.576739+00:00",
  "scraper_version": "2.0"
}
```

**Out-of-stock update:**
```json
{
  "url": "https://mokcoffee.be/collections/coffee/products/kenya-kianamui-ab-washed",
  "in_stock": false,
  "scraped_at": "2025-11-19T16:20:02.578790+00:00",
  "scraper_version": "2.0"
}
```

#### 2. Price Updates

Update price information when it changes:

```json
{
  "url": "https://example.com/products/coffee-bean",
  "price": 15.50,
  "weight": 250,
  "currency": "EUR",
  "price_options": [
    {"weight": 250, "price": 15.50},
    {"weight": 1000, "price": 55.00}
  ],
  "scraped_at": "2025-11-19T16:20:02.576739+00:00",
  "scraper_version": "2.0"
}
```

#### 3. Field Updates

Update specific fields that may have changed:

```json
{
  "url": "https://example.com/products/coffee-bean",
  "name": "Updated Coffee Name",
  "roast_level": "Medium",
  "description": "Updated description text...",
  "tasting_notes": ["Floral", "Citrus", "Sweet"],
  "scraped_at": "2025-11-19T16:20:02.576739+00:00",
  "scraper_version": "2.0"
}
```

## Data Validation

All data is validated using Pydantic v2 schemas:

- **`CoffeeBean`**: Full bean data schema (used for JSON files)
- **`CoffeeBeanDiffUpdate`**: Partial update schema (used for diffjson files)

### Validation Rules

1. **URLs**: Must be valid HTTP/HTTPS URLs
2. **Prices**: Must be positive numbers
3. **Weights**: Must be within reasonable ranges (10-10000g for full beans, 50-10000g for updates)
4. **Cupping scores**: Must be between 70-100 if provided
5. **Elevation**: Must be between 0-3000 meters
6. **Coordinates**: Latitude (-90 to 90), Longitude (-180 to 180)
7. **Currency**: Three-letter ISO currency codes
8. **Country codes**: Two-letter ISO country codes
9. **Price validation**: USD-equivalent prices are validated to be within reasonable ranges
10. **Tasting notes**: Automatically cleaned (normalized, deduplicated, empty strings removed)

### Serialization

- **JSON files**: Serialized using `bean.model_dump_json(indent=2)` (Pydantic method)
- **DiffJSON files**: Serialized using `json.dump(update_data, f, indent=2, ensure_ascii=False)`
- **Datetimes**: Serialized as ISO 8601 strings with timezone information
- **Enums**: Serialized as their string values

## Examples

### Example: Full JSON Bean File

```json
{
  "name": "Espresso A, Ethiopia, Suke Quto",
  "roaster": "MOK Coffee",
  "url": "https://mokcoffee.be/collections/coffee/products/espresso-a-sukequto",
  "image_url": "https://mokcoffee.be/cdn/shop/files/Espresso-A-Suke-Quto-2025-250G.gif?v=1756817895",
  "description": "Tesfaye Bekele is a pioneer of modern Guji coffee...",
  "origins": [
    {
      "country": "ET",
      "region": "Guji",
      "producer": "Tesfaye Bekele",
      "farm": "Suke Quto Farm",
      "elevation_min": 0,
      "elevation_max": 0,
      "latitude": null,
      "longitude": null,
      "process": "Washed",
      "variety": "Bourbon, Jackson Bourbon",
      "harvest_date": null,
      "fob_price": null,
      "farm_gate_price": null,
      "price_paid_to_producer": null,
      "price_currency": null,
      "importer_name": null
    }
  ],
  "is_single_origin": true,
  "price_paid_for_green_coffee": null,
  "currency_of_price_paid_for_green_coffee": null,
  "roast_level": null,
  "roast_profile": "Espresso",
  "price_options": [
    {
      "weight": 250,
      "price": 12.0
    },
    {
      "weight": 1000,
      "price": 39.0
    }
  ],
  "price": 12.0,
  "weight": 250,
  "currency": "GBP",
  "is_decaf": false,
  "cupping_score": null,
  "tasting_notes": [],
  "in_stock": true,
  "scraped_at": "2025-11-19T16:20:13.477435+00:00",
  "scraper_version": "2.0",
  "raw_data": null
}
```

### Example: DiffJSON Stock Update

```json
{
  "url": "https://mokcoffee.be/collections/coffee/products/costarica-laslajas",
  "in_stock": true,
  "scraped_at": "2025-11-19T16:20:02.576739+00:00",
  "scraper_version": "2.0"
}
```

### Example: DiffJSON Out-of-Stock Update

```json
{
  "url": "https://mokcoffee.be/collections/coffee/products/kenya-kianamui-ab-washed",
  "in_stock": false,
  "scraped_at": "2025-11-19T16:20:02.578790+00:00",
  "scraper_version": "2.0"
}
```

## File Processing

### How DiffJSON Files Are Applied

When loading data into the database, the system:

1. **Loads all JSON files** first to establish the base dataset
2. **Finds all diffjson files** using glob pattern: `data/**/*.diffjson`
3. **Validates each diffjson** using `CoffeeBeanDiffUpdate` schema
4. **Sorts diffjson files** by `scraped_at` timestamp (chronologically)
5. **Applies updates** to existing beans matching the `url` field
6. **Updates only specified fields** - fields not in the diffjson remain unchanged

This allows the system to maintain a complete history of changes while efficiently tracking updates without re-scraping entire product pages.

## Notes

- **File encoding**: All JSON files use UTF-8 encoding
- **Indentation**: JSON files use 2-space indentation for readability
- **Timezone**: All timestamps use UTC timezone
- **Image files**: Product images are saved as PNG files with the same base name as the JSON file (e.g., `bean_uid.png`)
- **Original language files**: Some scrapers may save `.originaljson` files containing data in the original language before translation
- **URL as identifier**: The `url` field serves as the unique identifier for coffee beans across scraping sessions

